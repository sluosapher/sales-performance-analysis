# Authentication & Web Interface Design

**Date:** 2026-02-01
**Status:** Approved for Implementation

## Overview

Add username/password authentication with page-level permissions to the sales performance analysis system. Support both web browser access and MCP agent access with per-user secret tokens.

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      Web Browser / AI Agent                  │
└──────────────────┬────────────────────┬─────────────────────┘
                   │                    │
                   │                    │
           ┌───────▼────────┐    ┌─────▼────────┐
           │ Flask Web Server│    │ MCP Server   │
           │ (Port 8004)    │    │ (Port 8003)  │
           └───────┬────────┘    └─────┬──────────┘
                   │                  │
                   └─────────┬────────┘
                             │
                    ┌────────▼──────────┐
                    │ SQLite Database   │
                    │ (users.db)        │
                    └───────────────────┘
```

## Database Schema

```sql
users table:
- id (primary key)
- username (unique, string)
- password_hash (string) - Bcrypt hashed
- secret_token (unique, string, nullable) - UUID format for MCP access
- role (enum: 'admin', 'user')
- can_upload (boolean, default: false) - Access to upload page
- can_list_results (boolean, default: true) - Access to list results page
- created_at (timestamp)
- last_login (timestamp)
```

## Authentication System

### Technologies
- **Flask-Login**: Session management with 3-day (72 hour) lifetime
- **Flask-Bcrypt**: Password hashing (12 rounds)
- **Flask-WTF**: CSRF protection
- **SQLite**: Local file-based database
- **SQLAlchemy ORM**: Database operations

### Session Configuration
```python
app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(days=3)
app.config['SESSION_COOKIE_HTTPONLY'] = True
app.config['SESSION_COOKIE_SECURE'] = True  # HTTPS only in production
app.config['SECRET_KEY'] = 'your-secret-key-here'
```

### Security Features
- Bcrypt password hashing
- HttpOnly, Secure, SameSite cookies
- CSRF protection on all forms
- SQL injection prevention via ORM
- XSS prevention via Jinja2 auto-escaping
- File upload validation (.xlsx only, 50MB limit)

## Page Structure & Permissions

### Public Pages
- `/login` - Login form
- `/logout` - Logout handler

### Authenticated Pages (require login)
- `/` - Redirects to upload or list results based on permissions
- `/upload` - Upload and process files (requires `can_upload = true`)
- `/list-results` - List and download result files (requires `can_list_results = true`)
- `/profile` - View user token and change password
- `/download/<filename>` - Download Excel files (requires authentication)

### Admin Pages (require `role = 'admin'`)
- `/admin/users/` - List all users
- `/admin/users/add` - Add new user
- `/admin/users/<id>/edit` - Edit user (permissions, regenerate token)
- `/admin/users/<id>/delete` - Delete user
- `/admin/users/<id>/reset-password` - Reset user password

## User Management Features

### Admin Capabilities
- Create users (set username, initial password, permissions)
- Edit user permissions (toggle `can_upload`, `can_list_results`)
- Regenerate user secret tokens
- Reset user passwords
- Delete users (cannot delete self)
- View all users table with: username, role, permissions, created date, last login

### User Self-Service
- View profile page with their secret token
- Copy token to clipboard with button
- Instructions for using token with MCP tools
- Change password (required on first login if temp password)

### Password Management
- Minimum 8 characters
- Admin sets temporary passwords for new users
- Users forced to change password on first login
- Password reset with confirmation

## Token Management

### Token Generation
- Automatically generated on user creation
- UUID4 format (32+ character random string)
- Unique per user, stored in database
- Not hashed (unlike passwords)
- Can be regenerated by admin

### Token Usage
- Used for MCP tool authentication
- Passed via Authorization header: `Bearer <token>`
- Each user has their own unique token
- Admin can view/regenerate tokens in admin interface

### MCP Tool Updates
MCP tools keep token-based authorization but check against database:

```python
def verify_authorization() -> tuple[bool, str | None, str]:
    """Verify token and return (is_valid, username, message)"""
    headers = get_http_headers()
    auth = headers.get("authorization") or headers.get("Authorization")

    if not auth:
        return False, None, "No authorization header"

    if auth.startswith("Bearer "):
        token = auth.removeprefix("Bearer ").strip()
    else:
        token = auth.strip()

    # Check token against database
    user = get_user_by_token(token)
    if user:
        return True, user.username, f"valid token for user: {user.username}"
    else:
        return False, None, "invalid token"
```

## Navigation & UI

### Navigation Bar (authenticated users only)
```
┌───────────────────────────────────────────────────────────────┐
│ Sales Analysis Portal                      [Logout] [Profile]│
├───────────────────────────────────────────────────────────────┤
│ [ Upload Files ]  [ List Results ]  [Admin] (if admin)      │
└───────────────────────────────────────────────────────────────┘
```

**Menu Visibility:**
- Upload Files: Only if `can_upload = true`
- List Results: Only if `can_list_results = true`
- Admin: Only if `role = 'admin'`

### Access Redirects
- Unauthenticated → redirect to `/login`
- After login → redirect to `/upload` if `can_upload`, else `/list-results`
- Insufficient permissions → show "Access Denied" page
- Logout → redirect to `/login`

## Security Considerations

### File Upload Security
- Extension validation (.xlsx only)
- Filename sanitization with `secure_filename()`
- Size limit: 50MB
- Temporary file cleanup after processing

### Session Security
- HttpOnly cookies (prevent JavaScript access)
- Secure cookies (HTTPS only in production)
- SameSite=Lax protection
- 3-day timeout
- "Remember me" extends to 30 days

### Admin Security
- Only admin role accesses `/admin/*` routes
- Admin cannot delete themselves
- Token regeneration requires confirmation
- All admin operations have CSRF protection

## Implementation Phases

1. **Phase 1:** Database setup, User model, Flask-Login integration
2. **Phase 2:** Login/logout pages, authentication decorators
3. **Phase 3:** Protect existing upload/list pages with permissions
4. **Phase 4:** Admin interface (user CRUD operations)
5. **Phase 5:** Token management, profile page, password reset
6. **Phase 6:** UI polish, navigation, access denied pages
7. **Phase 7:** MCP server token verification update
8. **Phase 8:** Security audit, testing, documentation

## Dependencies

- Flask-Login >= 0.6.0
- Flask-Bcrypt >= 1.0.0
- Flask-WTF >= 1.0.0
- Flask-SQLAlchemy >= 3.0.0
- SQLAlchemy >= 2.0.0
- Werkzeug >= 2.0.0

## Database File

- Location: `data/users.db` (gitignored)
- Created automatically on first run
- Backup recommended for production

## Test Data

- Admin user: `admin` / `admin123` (force change on first login)
- Regular user: `user` / `user123` (can_list only)
- Upload user: `uploader` / `upload123` (can_upload and can_list)

## Notes

- Remove global `API_TOKEN` constant from `sales_mcp_server.py`
- Update `verify_authorization()` to query database
- Keep existing MCP tools (`upload-input`, `list-results`, `get-result`) unchanged
- Web server runs independently with authentication layer
- MCP server runs separately on port 8003 with token checks
