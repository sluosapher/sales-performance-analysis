{% extends "base.html" %}

{% block title %}Profile - {{ super() }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h4>User Information</h4>
            </div>
            <div class="card-body">
                <p><strong>Username:</strong> {{ current_user.username }}</p>
                <p><strong>Role:</strong> {{ current_user.role|title }}</p>
                <p><strong>Permissions:</strong></p>
                <ul>
                    <li>Upload Files: {{ 'Yes' if current_user.can_upload else 'No' }}</li>
                    <li>List Results: {{ 'Yes' if current_user.can_list_results else 'No' }}</li>
                </ul>
                <p><strong>Last Login:</strong> {{ current_user.last_login or 'Never' }}</p>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h4>MCP Access Token</h4>
            </div>
            <div class="card-body">
                <p>Use this token with MCP tools for programmatic access:</p>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" value="{{ current_user.secret_token }}" readonly id="tokenDisplay">
                    <button class="btn btn-outline-secondary" type="button" onclick="copyToken()">Copy</button>
                </div>
                <div class="form-text">
                    Pass this token via Authorization header: <code>Bearer {{ current_user.secret_token }}</code>
                </div>

                <hr>
                <form method="POST">
                    {{ token_form.hidden_tag() }}
                    {{ token_form.submit(class="btn btn-warning btn-sm",
                                       onclick="return confirm('Are you sure you want to regenerate your token?')") }}
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h4>Change Password</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    {{ password_form.hidden_tag() }}

                    <div class="mb-3">
                        {{ password_form.current_password.label(class="form-label") }}
                        {{ password_form.current_password(class="form-control") }}
                        {% for error in password_form.current_password.errors %}
                            <div class="text-danger">{{ error }}</div>
                        {% endfor %}
                    </div>

                    <div class="mb-3">
                        {{ password_form.new_password.label(class="form-label") }}
                        {{ password_form.new_password(class="form-control") }}
                        {% for error in password_form.new_password.errors %}
                            <div class="text-danger">{{ error }}</div>
                        {% endfor %}
                    </div>

                    <div class="mb-3">
                        {{ password_form.confirm_password.label(class="form-label") }}
                        {{ password_form.confirm_password(class="form-control") }}
                        {% for error in password_form.confirm_password.errors %}
                            <div class="text-danger">{{ error }}</div>
                        {% endfor %}
                    </div>

                    {{ password_form.submit(class="btn btn-primary") }}
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function copyToken() {
    const tokenDisplay = document.getElementById('tokenDisplay');
    tokenDisplay.select();
    document.execCommand('copy');

    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(() => {
        btn.textContent = originalText;
    }, 2000);
}
</script>
{% endblock %}
